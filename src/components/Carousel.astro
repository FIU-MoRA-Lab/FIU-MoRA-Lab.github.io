---


interface Props {
    projects: any[]; // Type should ideally be imported but 'any' avoids circular dep issues for now or we can structure strictly
}

const { projects } = Astro.props;
---

<div
    class="carousel-container relative group h-[500px] flex flex-col justify-center"
>
    <!-- Navigation Buttons -->
    <button
        class="carousel-prev absolute left-0 top-1/2 -translate-y-1/2 z-10 p-3 bg-white/80 dark:bg-black/50 hover:bg-white dark:hover:bg-black backdrop-blur-md rounded-full shadow-lg text-black dark:text-white transition-all opacity-0 group-hover:opacity-100 disabled:opacity-0 -ml-4 md:-ml-8"
        aria-label="Previous project"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15.75 19.5L8.25 12l7.5-7.5"></path>
        </svg>
    </button>

    <button
        class="carousel-next absolute right-0 top-1/2 -translate-y-1/2 z-10 p-3 bg-white/80 dark:bg-black/50 hover:bg-white dark:hover:bg-black backdrop-blur-md rounded-full shadow-lg text-black dark:text-white transition-all opacity-0 group-hover:opacity-100 disabled:opacity-0 -mr-4 md:-mr-8"
        aria-label="Next project"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M8.25 4.5l7.5 7.5-7.5 7.5"></path>
        </svg>
    </button>

    <!-- Carousel Track -->
    <div
        class="carousel-track flex overflow-x-auto snap-x snap-mandatory gap-4 scroll-smooth no-scrollbar h-full items-center px-4 md:px-8"
    >
        {
            projects.map((project, index) => (
                <div class="carousel-slide relative flex-shrink-0 w-full h-full snap-center overflow-hidden bg-black">
                    <!-- Background Image -->
                    <img
                        src={project.data.image}
                        alt={project.data.title}
                        class="absolute inset-0 w-full h-full object-cover opacity-70"
                    />
                    
                    <!-- Gradient Overlay -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent pointer-events-none"></div>

                    <!-- Content Overlay -->
                    <div class="absolute bottom-0 left-0 w-full p-6 md:p-10 flex flex-col justify-end h-full pointer-events-none">
                        <div class="pointer-events-auto max-w-3xl"> <!-- Constrain text width -->
                             <h2 class="text-2xl md:text-4xl font-bold text-white mb-3 tracking-tight">
                                {project.data.title}
                             </h2>
                             
                             <p class="text-sm md:text-base text-gray-200 line-clamp-3 mb-6 font-light leading-relaxed">
                                {project.data.description}
                             </p>

                            {project.data.link && (
                                <a
                                    href={project.data.link.url}
                                    target={project.data.link.url.startsWith("/") ? "_self" : "_blank"}
                                    rel={project.data.link.url.startsWith("/") ? "" : "noopener noreferrer"}
                                    class="text-gray-300 hover:text-white underline decoration-1 underline-offset-4 transition-colors"
                                >
                                    [{project.data.link.label}]
                                </a>
                            )}
                        </div>
                    </div>
                </div>
            ))
        }
    </div>

    <!-- Indicators -->
    <div
        class="absolute bottom-4 left-1/2 -translate-x-1/2 flex justify-center gap-2 z-10"
    >
        {
            projects.map((_, index) => (
                <button
                    class="carousel-dot w-2.5 h-2.5 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors hover:bg-gray-400 dark:hover:bg-gray-600"
                    aria-label={`Go to project ${index + 1}`}
                    data-index={index}
                />
            ))
        }
    </div>
</div>

<style>
    /* Hide scrollbar for Chrome, Safari and Opera */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    /* Hide scrollbar for IE, Edge and Firefox */
    .no-scrollbar {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
    }

    .carousel-dot.active {
        background-color: var(--color-highlight, #7fb4ca);
    }
</style>

<script>
    function setupCarousel() {
        const containers = document.querySelectorAll(".carousel-container");

        containers.forEach((container) => {
            const track = container.querySelector(
                ".carousel-track",
            ) as HTMLElement;
            const prevBtn = container.querySelector(
                ".carousel-prev",
            ) as HTMLButtonElement;
            const nextBtn = container.querySelector(
                ".carousel-next",
            ) as HTMLButtonElement;
            const dots = container.querySelectorAll(".carousel-dot");
            const slides = container.querySelectorAll(".carousel-slide");

            if (!track || !prevBtn || !nextBtn) return;

            let activeIndex = 0;

            const updateState = () => {
                // Find the active slide
                const trackCenter = track.scrollLeft + track.clientWidth / 2;
                let minDiff = Infinity;

                slides.forEach((slide, index) => {
                    const slideCenter =
                        (slide as HTMLElement).offsetLeft +
                        (slide as HTMLElement).offsetWidth / 2;
                    const diff = Math.abs(trackCenter - slideCenter);
                    if (diff < minDiff) {
                        minDiff = diff;
                        activeIndex = index;
                    }
                });

                // Update dots
                dots.forEach((dot, index) => {
                    if (index === activeIndex) {
                        dot.classList.add("active");
                    } else {
                        dot.classList.remove("active");
                    }
                });
            };

            // Initial update
            updateState();

            // Listen for scroll
            track.addEventListener("scroll", () => {
                requestAnimationFrame(updateState);
            });

            // Navigation clicks
            const scrollToSlide = (index: number) => {
                if (index < 0 || index >= slides.length) return;
                const slide = slides[index] as HTMLElement;
                
                // Account for track padding if necessary, but offsetLeft is usually from parent.
                // However, with snap-center, we want to center the slide.
                // Or just rely on scrollIntoView? scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }) is great.
                
                slide.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center'
                });
            };

            prevBtn.addEventListener("click", () => {
                scrollToSlide(activeIndex - 1);
            });

            nextBtn.addEventListener("click", () => {
                scrollToSlide(activeIndex + 1);
            });

            // Dot clicks
            dots.forEach((dot) => {
                dot.addEventListener("click", (e) => {
                    const index = parseInt(
                        (e.target as HTMLElement).dataset.index || "0",
                    );
                    scrollToSlide(index);
                });
            });
        });
    }

    // Run on load and after Astro swaps
    document.addEventListener("astro:page-load", setupCarousel);
    // Also run immediately in case of partial hydration or standard load
    setupCarousel();
</script>
