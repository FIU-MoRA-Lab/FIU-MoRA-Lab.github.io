---
import Layout from "../layouts/Layout.astro";
import PublicationsList from "../components/PublicationsList.astro";
import PageHeader from "../components/PageHeader.astro";
import { fetchPublications, normalizeName } from "../utils/publications";
import { getCollection } from "astro:content";

import chroma from "chroma-js";

const publications = await fetchPublications();
const teamMembers = await getCollection("team");

// Generate dynamic color palette using chroma-js
// Using 'Spectral' scale which provides good distinction for categories
const palette = chroma
    .scale("Spectral")
    .mode("lch")
    .colors(teamMembers.length)
    .sort(() => Math.random() - 0.5);

const authors = teamMembers
    .map((member, index) => {
        const baseColor = palette[index];
        return {
            name: member.data.name,
            slug: normalizeName(member.data.name),
            color: baseColor,
            // Light Mode -> Darker colors (for contrast on white background)
            colorLight: chroma(baseColor).darken(1.8).hex(),
            // Dark Mode -> Almost White Pastel (Lighter text request)
            colorDark: chroma(baseColor).set('hsl.s', 0.3).set('hsl.l', 0.65).hex(),
        };
    })
    .sort((a, b) => a.name.localeCompare(b.name));

const years = [...new Set(publications.map((p) => p.year))].sort(
    (a, b) => parseInt(b) - parseInt(a),
);
---

<Layout title="Publications - MoRA Lab">
    <div class="container mx-auto px-4 max-w-4xl pt-4 pb-8 md:pt-8 md:pb-16">
        <PageHeader title="Publications" />

        <div class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8 items-start">
            <div id="author-filters" class="w-full md:col-span-2">
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer list-none select-none mb-4 bg-neutral-50 dark:bg-neutral-900 p-2 rounded-lg" style="cursor: pointer;">
                        <h2 class="text-lg text-gray-700 dark:text-gray-200 transition-[font-variation-settings,color] duration-200 [font-variation-settings:'wght'_600] group-hover:[font-variation-settings:'wght'_700] group-hover:text-[var(--color-highlight)] dark:group-hover:text-[var(--color-highlight)] pl-2">
                            Filter by Author
                        </h2>
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-all duration-200 group-open:rotate-180 group-hover:text-[var(--color-highlight)] dark:group-hover:text-[var(--color-highlight)]"
                        >
                            <path d="m6 9 6 6 6-6"></path>
                        </svg>
                    </summary>
                    <div class="flex flex-wrap gap-1 md:gap-2 p-4 rounded-lg bg-neutral-50 dark:bg-neutral-900 animate-in fade-in zoom-in-95 duration-200 mt-2">
                        {
                            authors.map((author) => {
                                // Helper to get RGBA from hex with opacity
                                const getRgba = (hex: string, opacity: number) => {
                                    const r = parseInt(hex.slice(1, 3), 16);
                                    const g = parseInt(hex.slice(3, 5), 16);
                                    const b = parseInt(hex.slice(5, 7), 16);
                                    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
                                };

                                // Light Mode: Dark Text, Light BG
                                const bgLight = getRgba(author.colorLight, 0.25);
                                
                                // Dark Mode: Light Text, Subtle BG
                                const bgDark = getRgba(author.colorDark, 0.2);

                                return (
                                    <label class="relative cursor-pointer select-none group">
                                        <input
                                            type="checkbox"
                                            value={author.slug}
                                            data-color={author.color}
                                            data-color-light={author.colorLight}
                                            data-color-dark={author.colorDark}
                                            data-bg-light={bgLight}
                                            data-bg-dark={bgDark}
                                            class="author-checkbox peer sr-only"
                                        />
                                        <span 
                                            class="author-chip block px-2 py-1 text-sm rounded transition-all duration-200 text-gray-700 dark:text-gray-300 bg-[#fafafa] dark:bg-neutral-900 font-medium"
                                            style={`
                                                --author-text-light: ${author.colorLight};
                                                --author-bg-light: ${bgLight};
                                                --author-text-dark: ${author.colorDark};
                                                --author-bg-dark: ${bgDark};
                                            `}
                                        >
                                            {author.name}
                                        </span>
                                    </label>
                                );
                            })
                        }
                    </div>
                </details>
            </div>

            <div id="year-filters" class="w-full">
                <details class="group">
                    <summary class="flex items-center justify-between cursor-pointer list-none select-none mb-4 bg-neutral-50 dark:bg-neutral-900 p-2 rounded-lg" style="cursor: pointer;">
                        <h2 class="text-lg text-gray-700 dark:text-gray-200 transition-[font-variation-settings,color] duration-200 [font-variation-settings:'wght'_600] group-hover:[font-variation-settings:'wght'_700] group-hover:text-[var(--color-highlight)] dark:group-hover:text-[var(--color-highlight)] pl-2">
                            Filter by Year
                        </h2>
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-all duration-200 group-open:rotate-180 group-hover:text-[var(--color-highlight)] dark:group-hover:text-[var(--color-highlight)]"
                        >
                            <path d="m6 9 6 6 6-6"></path>
                        </svg>
                    </summary>
                    <div class="flex flex-wrap gap-1 md:gap-2 p-4 rounded-lg bg-neutral-50 dark:bg-neutral-900 animate-in fade-in zoom-in-95 duration-200 mt-2">
                        {
                            years.map((year) => (
                                <label class="relative cursor-pointer select-none">
                                    <input
                                        type="checkbox"
                                        value={year}
                                        class="year-checkbox peer sr-only"
                                    />
                                    <span class="year-chip block px-3 py-1 text-sm rounded-full transition-all duration-200 text-gray-700 dark:text-gray-300 bg-[#fafafa] dark:bg-neutral-900 peer-checked:bg-gray-800 peer-checked:text-white dark:peer-checked:bg-gray-200 dark:peer-checked:text-black text-center" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;">
                                        {year}
                                    </span>
                                    <style>
                                        /* Apply hover effects only when NOT checked */
                                        input:not(:checked) + .year-chip:hover {
                                            background-color: #e0e0e0 !important;
                                            color: rgb(0 0 0) !important; /* BLACK text on hover */
                                            font-weight: 800;
                                        }
                                        
                                        /* Dark mode hover - only when NOT checked */
                                        :root.dark input:not(:checked) + .year-chip:hover {
                                            background-color: rgb(38 38 38) !important; /* dark:hover:bg-neutral-800 */
                                            color: rgb(255 255 255) !important; /* white text on hover in dark mode */
                                        }
                                        
                                        /* Checked state always has bold font */
                                        input:checked + .year-chip {
                                            font-weight: 800;
                                        }
                                    </style>
                                </label>
                            ))
                        }
                    </div>
                </details>
            </div>
        </div>

        <PublicationsList publications={publications} />
    </div>
    </div>
</Layout>

<style>
    /* Author Filter Chip Styles */
    
    /* Hover effects (Unchecked) */
    .author-checkbox:not(:checked) + .author-chip:hover {
        background-color: #e0e0e0 !important;
    }

    :global(.dark) .author-checkbox:not(:checked) + .author-chip:hover {
        background-color: rgb(38 38 38) !important;
    }

    /* Checked State */
    .author-checkbox:checked + .author-chip {
        background-color: var(--author-bg-light) !important;
        border-color: transparent !important;
        color: var(--author-text-light) !important;
    }

    :global(.dark) .author-checkbox:checked + .author-chip {
        background-color: var(--author-bg-dark) !important;
        color: var(--author-text-dark) !important;
    }

    /* Global styles for dynamic author highlights in the list */
    :global(.author-name.selected-author) {
        background-color: var(--author-bg-light) !important;
        color: var(--author-text-light) !important;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-weight: 500; /* font-medium */
        cursor: default;
    }

    :global(.dark .author-name.selected-author) {
        background-color: var(--author-bg-dark) !important;
        color: var(--author-text-dark) !important;
    }
</style>

<script>
    function initPublications() {
        // Wait for DOM elements to be available
        // Use requestAnimationFrame to ensure rendering is complete
        requestAnimationFrame(() => {
            // Re-select elements on every navigation
            const authorCheckboxes = document.querySelectorAll(".author-checkbox");
            const yearCheckboxes = document.querySelectorAll(".year-checkbox");
            const publications = document.querySelectorAll(".publication-item");
            const yearSections = document.querySelectorAll(".year-section");

            // Defensive check: ensure critical elements exist before proceeding
            if (publications.length === 0) {
                console.warn("Publication items not found, trying again...");
                // Retry after a short delay if elements aren't available yet
                setTimeout(initPublications, 50);
                return;
            }

            function updateFilters() {
                // Get selected authors and their colors
                const selectedAuthorSlugs: string[] = [];
                const authorColors: Record<string, string> = {};

                authorCheckboxes.forEach((cb) => {
                    const input = cb as HTMLInputElement;
                    if (input.checked) {
                        const slug = input.value;
                        selectedAuthorSlugs.push(slug);
                        authorColors[slug] = input.dataset.color || "";
                    }
                });

                // Get selected years
                const selectedYears = Array.from(yearCheckboxes)
                    .filter((cb) => (cb as HTMLInputElement).checked)
                    .map((cb) => (cb as HTMLInputElement).value);

                // Filter items
                publications.forEach((item) => {
                    const el = item as HTMLElement;
                    const authors = JSON.parse(el.dataset.authors || "[]");
                    
                    const yearSection = el.closest(".year-section") as HTMLElement;
                    const itemYear = yearSection ? yearSection.dataset.year : "";

                    const authorMatch =
                        selectedAuthorSlugs.length === 0 ||
                        authors.some((author: string) =>
                            selectedAuthorSlugs.includes(author),
                        );
                    const yearMatch =
                        selectedYears.length === 0 ||
                        (itemYear && selectedYears.includes(itemYear));

                    const shouldShow = authorMatch && yearMatch;

                    el.style.display = shouldShow ? "" : "none";

                    // Toggle highlights
                    const authorSpans = el.querySelectorAll(".author-name");
                    authorSpans.forEach((span) => {
                        const elSpan = span as HTMLElement;
                        const spanSlug = elSpan.dataset.authorSlug;
                        
                        // Reset styles
                        elSpan.style.removeProperty("--author-text-light");
                        elSpan.style.removeProperty("--author-bg-light");
                        elSpan.style.removeProperty("--author-text-dark");
                        elSpan.style.removeProperty("--author-bg-dark");
                        elSpan.classList.remove("selected-author");

                        if (spanSlug && selectedAuthorSlugs.includes(spanSlug)) {
                            // Apply specific color vars
                            // We need to look up the data from the checkbox since we didn't store it in the authorColors map with all details
                            // Let's grab it from the DOM element we matched earlier or rely on authorColors if we structured it
                            // For simplicity, let's re-query or better, store complex objects in authorColors
                            
                            // Re-find key
                            const checkbox = document.querySelector(`.author-checkbox[value="${spanSlug}"]`) as HTMLInputElement;
                            if (checkbox) {
                                elSpan.style.setProperty("--author-text-light", checkbox.dataset.colorLight || "");
                                elSpan.style.setProperty("--author-bg-light", checkbox.dataset.bgLight || "");
                                elSpan.style.setProperty("--author-text-dark", checkbox.dataset.colorDark || "");
                                elSpan.style.setProperty("--author-bg-dark", checkbox.dataset.bgDark || "");
                                
                                elSpan.classList.add("selected-author");
                            }
                            
                            // Remove global highlight class
                            elSpan.classList.remove("text-[var(--color-highlight)]", "font-bold");
                        } else if (spanSlug) {
                             // Ensure global class isn't stuck
                             elSpan.classList.remove("text-[var(--color-highlight)]", "font-bold");
                        }
                    });
                });

                // Hide empty years
                yearSections.forEach((section) => {
                    const visibleItems = section.querySelectorAll(
                        ".publication-item:not([style*='display: none'])",
                    );
                    (section as HTMLElement).style.display =
                        visibleItems.length > 0 ? "" : "none";
                });
            }

            // Only attach event listeners if we haven't already
            // Check if listeners are already attached by using a data attribute
            const isInitialized = document.body.dataset.publicationsInitialized;
            if (isInitialized) {
                return;
            }

            authorCheckboxes.forEach((cb) => {
                cb.addEventListener("change", updateFilters);
            });
            yearCheckboxes.forEach((cb) => {
                cb.addEventListener("change", updateFilters);
            });

            // Mark as initialized
            document.body.dataset.publicationsInitialized = "true";
        });
    }

    // Initialize on page load and after every View Transition navigation
    document.addEventListener("astro:page-load", initPublications);
</script>
